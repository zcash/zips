<!DOCTYPE html>
<html>
<head>
    <title>ZIP 230: Version 6 Transaction Format</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css" integrity="sha384-WcoG4HRXMzYzfCgiyfrySxx90XSl2rxY5mnVY5TwtWE6KLrArNKn0T/mOgNL0Mmi" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.js" integrity="sha384-J+9dG2KMoiR9hqcFao0IBLwxt6zpcyN68IgwzsCSkbreXUjmNVRhPFTssqdSGjwQ" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="css/style.css"></head>
<body>
    <section>
        <pre>ZIP: 230
Title: Version 6 Transaction Format
Owners: Daira-Emma Hopwood &lt;daira-emma@electriccoin.co&gt;
        Jack Grigg &lt;jack@electriccoin.co&gt;
        Sean Bowe &lt;sean@electriccoin.co&gt;
        Kris Nuttycombe &lt;kris@electriccoin.co&gt;
        Pablo Kogan &lt;pablo@qed-it.com&gt;
        Vivek Arte &lt;vivek@qed-it.com&gt;
Original-Authors: Greg Pfeil
                  Deirdre Connolly
Credits: Ying Tong Lai
Status: Draft
Category: Consensus
Created: 2023-04-18
License: MIT
Discussions-To: &lt;<a href="https://github.com/zcash/zips/issues/686">https://github.com/zcash/zips/issues/686</a>&gt;</pre>
        <section id="terminology"><h2><span class="section-heading">Terminology</span><span class="section-anchor"> <a rel="bookmark" href="#terminology"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>The key words "MUST", "SHOULD", and "MAY" in this document are to be interpreted as described in BCP 14 <a id="footnote-reference-1" class="footnote_reference" href="#bcp14">1</a> when, and only when, they appear in all capitals.</p>
            <p>The terms "Zcash Shielded Asset", "OrchardZSA", "ZSA" and "Asset" in this document are to be interpreted as described in ZIP 226 <a id="footnote-reference-2" class="footnote_reference" href="#zip-0226">13</a>.</p>
            <p>The term "Issuance" and "Issuance Action" in this document are to be interpreted as described in ZIP 227 <a id="footnote-reference-3" class="footnote_reference" href="#zip-0227">16</a>.</p>
            <p>The character § is used when referring to sections of the Zcash Protocol Specification <a id="footnote-reference-4" class="footnote_reference" href="#protocol">2</a>.</p>
        </section>
        <section id="abstract"><h2><span class="section-heading">Abstract</span><span class="section-anchor"> <a rel="bookmark" href="#abstract"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>This proposal defines a new Zcash peer-to-peer transaction format, which supports the changes being deployed in Network Upgrade 7 <a id="footnote-reference-5" class="footnote_reference" href="#draft-arya-deploy-nu7">32</a>. It follows the same design pattern as the v5 transaction format <a id="footnote-reference-6" class="footnote_reference" href="#zip-0225">11</a>.</p>
        </section>
        <section id="motivation"><h2><span class="section-heading">Motivation</span><span class="section-anchor"> <a rel="bookmark" href="#motivation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>The OrchardZSA protocol requires serialized data elements that are distinct from any previous Zcash transaction. Since ZIP 244 was activated in NU5, the v5 and later serialized transaction formats are not consensus-critical. Thus, this ZIP defines format that can easily accommodate future extensions, where elements or a given pool are kept separate.</p>
        </section>
        <section id="requirements"><h2><span class="section-heading">Requirements</span><span class="section-anchor"> <a rel="bookmark" href="#requirements"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>The new format must fully support the OrchardZSA protocol.</p>
            <p>The new format should lend itself to future extension or pruning to add or remove value pools.</p>
            <p>The computation of the non-malleable transaction identifier hash must include all newly incorporated elements except those that attest to transaction validity.</p>
            <p>The computation of the commitment to authorizing data for a transaction must include all newly incorporated elements that attest to transaction validity.</p>
        </section>
        <section id="non-requirements"><h2><span class="section-heading">Non-requirements</span><span class="section-anchor"> <a rel="bookmark" href="#non-requirements"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>More general forms of extensibility, such as definining a key/value format that allows for parsers that are unaware of some components, are not required.</p>
        </section>
        <section id="specification"><h2><span class="section-heading">Specification</span><span class="section-anchor"> <a rel="bookmark" href="#specification"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>All fields in this specification are encoded as little-endian.</p>
            <p>The Zcash transaction format for transaction version 6 is as follows:</p>
            <section id="transaction-format"><h3><span class="section-heading">Transaction Format</span><span class="section-anchor"> <a rel="bookmark" href="#transaction-format"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4"><strong>Common Transaction Fields</strong></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>header</code></td>
                            <td><code>uint32</code></td>
                            <td>
                                <p>Contains:</p>
                                <ul>
                                    <li><code>fOverwintered</code> flag (bit 31, always set)</li>
                                    <li><code>version</code> (bits 30 .. 0) – transaction version.</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>nVersionGroupId</code></td>
                            <td><code>uint32</code></td>
                            <td>Version group ID (nonzero).</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>nConsensusBranchId</code></td>
                            <td><code>uint32</code></td>
                            <td>Consensus branch ID (nonzero).</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>lock_time</code></td>
                            <td><code>uint32</code></td>
                            <td>Unix-epoch UTC time or block height, encoded as in Bitcoin.</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>nExpiryHeight</code></td>
                            <td><code>uint32</code></td>
                            <td>A block height in the range {1 .. 499999999} after which the transaction will expire, or 0 to disable expiry. <a id="footnote-reference-7" class="footnote_reference" href="#zip-0203">9</a></td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>fee</code></td>
                            <td><code>uint64</code></td>
                            <td>The fee to be paid by this transaction, in zatoshis.</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>zip233Amount</code></td>
                            <td><code>uint64</code></td>
                            <td>The value to be removed from circulation in this transaction, in zatoshis. <a id="footnote-reference-8" class="footnote_reference" href="#zip-0233">24</a></td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Transparent Transaction Fields</strong></td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>tx_in_count</code></td>
                            <td><code>compactSize</code></td>
                            <td>Number of transparent inputs in <code>tx_in</code>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>tx_in</code></td>
                            <td><code>tx_in</code></td>
                            <td>Transparent inputs, encoded as in Bitcoin.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>tx_out_count</code></td>
                            <td><code>compactSize</code></td>
                            <td>Number of transparent outputs in <code>tx_out</code>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>tx_out</code></td>
                            <td><code>tx_out</code></td>
                            <td>Transparent outputs, encoded as in Bitcoin.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vSighashInfo</code></td>
                            <td><code>TransparentSighashInfo[tx_in_count]</code></td>
                            <td>Sighash info for each transparent input.</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Sapling Transaction Fields</strong></td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nSpendsSapling</code></td>
                            <td><code>compactSize</code></td>
                            <td>Number of Sapling Spend descriptions in <code>vSpendsSapling</code>.</td>
                        </tr>
                        <tr>
                            <td>96 × <code>nSpendsSapling</code></td>
                            <td><code>vSpendsSapling</code></td>
                            <td><code>SpendDescriptionV5[nSpendsSapling]</code></td>
                            <td>A sequence of Sapling Spend descriptions, encoded per §7.3 ‘Spend Description Encoding and Consensus’ (unchanged from V5).</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nOutputsSapling</code></td>
                            <td><code>compactSize</code></td>
                            <td>Number of Sapling Output Decriptions in <code>vOutputsSapling</code>.</td>
                        </tr>
                        <tr>
                            <td>276 × <code>nOutputsSapling</code></td>
                            <td><code>vOutputsSapling</code></td>
                            <td><code>OutputDescriptionV6[nOutputsSapling]</code></td>
                            <td>A sequence of Sapling Output descriptions, encoded per §7.4 ‘Output Description Encoding and Consensus’.</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>valueBalanceSapling</code></td>
                            <td><code>int64</code></td>
                            <td>The net value of Sapling Spends minus Outputs</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>anchorSapling</code></td>
                            <td><code>byte[32]</code></td>
                            <td>A root of the Sapling note commitment tree at some block height in the past.</td>
                        </tr>
                        <tr>
                            <td>192 × <code>nSpendsSapling</code></td>
                            <td><code>vSpendProofsSapling</code></td>
                            <td><code>byte[192 * nSpendsSapling]</code></td>
                            <td>Encodings of the zk-SNARK proofs for each Sapling Spend.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vSpendAuthSigsSapling</code></td>
                            <td><code>SaplingSignature[nSpendsSapling]</code></td>
                            <td>Authorizing signatures for each Sapling Spend.</td>
                        </tr>
                        <tr>
                            <td>192 × <code>nOutputsSapling</code></td>
                            <td><code>vOutputProofsSapling</code></td>
                            <td><code>byte[192 * nOutputsSapling]</code></td>
                            <td>Encodings of the zk-SNARK proofs for each Sapling Output.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>bindingSigSapling</code></td>
                            <td><code>SaplingSignature</code></td>
                            <td>A Sapling binding signature on the SIGHASH transaction hash.</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Orchard Transaction Fields</strong></td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nActionGroupsOrchard</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of Action Group descriptions in <code>vActionGroupsOrchard</code>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vActionGroupsOrchard</code></td>
                            <td><code>ActionGroupDescription[nActionGroupsOrchard]</code></td>
                            <td>A sequence of Action Group descriptions, encoded as per the <a href="#orchardzsa-action-group-description">OrchardZSA Action Group Description</a>.</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>valueBalanceOrchard</code></td>
                            <td><code>int64</code></td>
                            <td>The net value of Orchard spends minus outputs.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>bindingSigOrchard</code></td>
                            <td><code>OrchardSignature</code></td>
                            <td>An OrchardZSA binding signature on the SIGHASH transaction hash.</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>ZSA Issuance Bundle Fields</strong></td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>issuerLength</code></td>
                            <td><code>compactSize</code></td>
                            <td>The length of the issuer identifier.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>issuer</code></td>
                            <td><code>byte[issuerLength]</code></td>
                            <td>The issuer identifier as defined in <a id="footnote-reference-9" class="footnote_reference" href="#zip-0227-issuer-identifier">18</a>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nIssueActions</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of issuance actions in the bundle.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vIssueActions</code></td>
                            <td><code>IssueAction[nIssueActions]</code></td>
                            <td>A sequence of issuance action descriptions.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>issueAuthSig</code></td>
                            <td><code>IssueAuthSignature</code></td>
                            <td>The signature of the transaction SIGHASH, signed by the issuer, validated as in Issuance Authorization Signature Scheme <a id="footnote-reference-10" class="footnote_reference" href="#zip-0227-issuance-auth-sig">17</a>.</td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>Memo Bundle Fields</strong></td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td><code>fAllPruned</code></td>
                            <td><code>uint8</code></td>
                            <td>1 if all chunks have been pruned, otherwise 0.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>nonceOrHash</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The nonce for deriving encryption keys, or the overall hash.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nMemoChunks</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of memo chunks.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>pruned</code></td>
                            <td><code>byte[</code>
                                <span class="math">\(\mathsf{ceiling}(\mathtt{nMemoChunks}/8)\)</span>
                             <code>]</code></td>
                            <td>Bitflags indicating the type of each entry in <code>vMemoChunks</code>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vMemoChunks</code></td>
                            <td><code>MemoChunk[nMemoChunks]</code></td>
                            <td>A sequence of encrypted memo chunks <a id="footnote-reference-11" class="footnote_reference" href="#zip-0231-memo-encryption">22</a>.</td>
                        </tr>
                    </tbody>
                </table>
                <ul>
                    <li>The fields <code>valueBalanceSapling</code> and <code>bindingSigSapling</code> are present if and only if
                        <span class="math">\(\mathtt{nSpendsSapling} + \mathtt{nOutputsSapling} &gt; 0\!\)</span>
                    . If <code>valueBalanceSapling</code> is not present, then
                        <span class="math">\(\mathsf{v^{balanceSapling}}\)</span>
                     is defined to be
                        <span class="math">\(0\!\)</span>
                    .</li>
                    <li>The field <code>anchorSapling</code> is present if and only if
                        <span class="math">\(\mathtt{nSpendsSapling} &gt; 0\!\)</span>
                    .</li>
                    <li>The elements of <code>vSpendProofsSapling</code> and <code>vSpendAuthSigsSapling</code> have a 1:1 correspondence to the elements of <code>vSpendsSapling</code> and MUST be ordered such that the proof or signature at a given index corresponds to the <code>SpendDescriptionV6</code> at the same index.</li>
                    <li>The elements of <code>vOutputProofsSapling</code> have a 1:1 correspondence to the elements of <code>vOutputsSapling</code> and MUST be ordered such that the proof at a given index corresponds to the <code>OutputDescriptionV6</code> at the same index.</li>
                    <li>The fields <code>valueBalanceOrchard</code> and <code>bindingSigOrchard</code> are present if and only if
                        <span class="math">\(\mathtt{nActionGroupsOrchard} &gt; 0\!\)</span>
                    . If <code>valueBalanceOrchard</code> is not present, then
                        <span class="math">\(\mathsf{v^{balanceOrchard}}\)</span>
                     is defined to be
                        <span class="math">\(0\!\)</span>
                    .</li>
                    <li>The fields <code>issueAuthSigLength</code> and <code>issueAuthSig</code> are present if and only if
                        <span class="math">\(\mathtt{nIssueActions} &gt; 0\!\)</span>
                    . The fields <code>issuerLength</code>, <code>issuer</code>, <code>nIssueActions</code>, and <code>vIssueActions</code> are always present. If
                        <span class="math">\(\mathtt{nIssueActions} = 0\)</span>
                     then <code>issuerLength</code> MUST be set to
                        <span class="math">\(0\)</span>
                     (<code>issuer</code> and <code>vIssueActions</code> will be empty in this case).</li>
                    <li>For coinbase transactions, the <code>enableSpendsOrchard</code> and <code>enableZSAs</code> bits MUST be set to
                        <span class="math">\(0\!\)</span>
                    .</li>
                    <li>The fields <code>nMemoChunks</code>, <code>pruned</code>, and <code>vMemoChunks</code> are present if and only if <code>fAllPruned == 0</code>.</li>
                    <li>If <code>fAllPruned == 0</code>, then:
                        <ul>
                            <li><code>nonceOrHash</code> contains the ZIP 231 nonce for deriving encryption keys.</li>
                            <li>Each bit of <code>pruned</code>, in little-endian order, indicates the type of the corresponding entry in <code>vMemoChunks</code>.
                                <ul>
                                    <li>A bit value of 0 indicates that the entry will be of type <code>byte[272]</code> representing an encrypted memo chunk.</li>
                                    <li>A bit value of 1 indicates the entry will be a <code>byte[32]</code> and contains the ZIP 246 <code>memo_chunk_digest</code> for a pruned chunk.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li>If <code>fAllPruned == 1</code>, then:
                        <ul>
                            <li><code>nonceOrHash</code> contains the ZIP 246 <code>memo_digest</code> for the pruned memo bundle.</li>
                        </ul>
                    </li>
                </ul>
                <p>The encodings of <code>tx_in</code>, and <code>tx_out</code> are as in prior transaction versions (i.e. unchanged since Zcash launch). <a id="footnote-reference-12" class="footnote_reference" href="#protocol-txnencoding">8</a> <a id="footnote-reference-13" class="footnote_reference" href="#zip-0225-transaction-format">12</a></p>
                <p>The encodings of <code>SpendDescriptionV6</code>, <code>OutputDescriptionV6</code>, <code>ActionGroupDescription</code>, <code>AssetBurn</code> and <code>IssueAction</code> are described below.</p>
                <p>The encoding of Sapling Spends and Outputs has changed relative to prior versions in order to better separate data that describe the effects of the transaction from the proofs of and commitments to those effects, and for symmetry with this separation in the Orchard-related parts of the transaction format.</p>
            </section>
            <section id="sapling-output-description-outputdescriptionv6"><h3><span class="section-heading">Sapling Output Description (<code>OutputDescriptionV6</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#sapling-output-description-outputdescriptionv6"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>32</td>
                            <td><code>cv</code></td>
                            <td><code>byte[32]</code></td>
                            <td>A value commitment to the net value of the output note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>cmu</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The
                                <span class="math">\(u\!\)</span>
                            -coordinate of the note commitment for the output note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>ephemeralKey</code></td>
                            <td><code>byte[32]</code></td>
                            <td>An encoding of an ephemeral Jubjub public key.</td>
                        </tr>
                        <tr>
                            <td>100</td>
                            <td><code>encCiphertext</code></td>
                            <td><code>byte[100]</code></td>
                            <td>The encrypted contents of the note plaintext.</td>
                        </tr>
                        <tr>
                            <td>80</td>
                            <td><code>outCiphertext</code></td>
                            <td><code>byte[80]</code></td>
                            <td>The encrypted contents of the byte string created by concatenation of the transmission key with the ephemeral secret key.</td>
                        </tr>
                    </tbody>
                </table>
                <p>The encodings of each of these elements are defined in §7.4 ‘Output Description Encoding and Consensus’ <a id="footnote-reference-14" class="footnote_reference" href="#protocol-outputdesc">4</a>.</p>
            </section>
            <section id="orchardzsa-action-group-description"><h3><span class="section-heading">OrchardZSA Action Group Description</span><span class="section-anchor"> <a rel="bookmark" href="#orchardzsa-action-group-description"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>The OrchardZSA Action Group Description is encoded in a transaction as an instance of an <code>ActionGroupDescription</code> type:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>varies</td>
                            <td><code>nActionsOrchard</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of Action descriptions in <code>vActionsOrchard</code>. This MUST have a value strictly greater than <code>0</code>.</td>
                        </tr>
                        <tr>
                            <td>372 × <code>nActionsOrchard</code></td>
                            <td><code>vActionsOrchard</code></td>
                            <td><code>OrchardZSAAction[nActionsOrchard]</code></td>
                            <td>A sequence of OrchardZSA Action descriptions in the Action Group.</td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td><code>flagsOrchard</code></td>
                            <td><code>byte</code></td>
                            <td>As defined in §7.1 ‘Transaction Encoding and Consensus’ <a id="footnote-reference-15" class="footnote_reference" href="#protocol-txnencoding">8</a>.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>anchorOrchard</code></td>
                            <td><code>byte[32]</code></td>
                            <td>As defined in §7.1 ‘Transaction Encoding and Consensus’ <a id="footnote-reference-16" class="footnote_reference" href="#protocol-txnencoding">8</a>.</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>nAGExpiryHeight</code></td>
                            <td><code>uint32</code></td>
                            <td>A block height in the range {1 .. 499999999} after which any transaction including this Action Group cannot be mined, or 0 if this Action Group places no constraint on transaction expiry.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nAssetBurn</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of Assets burnt.</td>
                        </tr>
                        <tr>
                            <td>40 × <code>nAssetBurn</code></td>
                            <td><code>vAssetBurn</code></td>
                            <td><code>AssetBurn[nAssetBurn]</code></td>
                            <td>A sequence of Asset Burn descriptions, encoded per <a href="#orchardzsa-asset-burn-description">OrchardZSA Asset Burn Description</a>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeProofsOrchard</code></td>
                            <td><code>compactSize</code></td>
                            <td>As defined in §7.1 ‘Transaction Encoding and Consensus’ <a id="footnote-reference-17" class="footnote_reference" href="#protocol-txnencoding">8</a>.</td>
                        </tr>
                        <tr>
                            <td><code>sizeProofsOrchard</code></td>
                            <td><code>proofsOrchard</code></td>
                            <td><code>byte[sizeProofsOrchard]</code></td>
                            <td>The aggregated zk-SNARK proof for all Actions in the Action Group.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>vSpendAuthSigsOrchard</code></td>
                            <td><code>OrchardSignature[nActionsOrchard]</code></td>
                            <td>Authorizing signatures for each Action of the Action Group in a transaction.</td>
                        </tr>
                    </tbody>
                </table>
                <p>The encodings of <code>OrchardZSAAction</code> and <code>AssetBurn</code> are described below.</p>
                <ul>
                    <li>The proofs aggregated in <code>proofsOrchardZSA</code>, and the elements of <code>vSpendAuthSigsOrchard</code>, each have a 1:1 correspondence to the elements of <code>vActionsOrchard</code> and MUST be ordered such that the proof or signature at a given index corresponds to the <code>OrchardZSAAction</code> at the same index.</li>
                    <li>If the value of <code>nAGExpiryHeight</code> is nonzero, it MUST be consistent with the <code>nExpiryHeight</code> of the overall transaction.</li>
                    <li>In NU7, <code>nExpiryHeight</code> MUST be set to <code>0</code>; this restriction is expected to be lifted in a future network upgrade.</li>
                </ul>
                <section id="rationale-for-nagexpiryheight"><h4><span class="section-heading">Rationale for nAGExpiryHeight</span><span class="section-anchor"> <a rel="bookmark" href="#rationale-for-nagexpiryheight"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>We introduce the <code>nAGExpiryHeight</code> field in this transaction format in order to be forward compatible with Swaps over ZSAs, as proposed in ZIP 228 <a id="footnote-reference-18" class="footnote_reference" href="#zip-0228">19</a>. For the OrchardZSA protocol, which does not make use of an additional expiry height for transactions, we set the value of <code>nAGExpiryHeight</code> to be <code>0</code> by consensus. This serves as a default value to represent the situation where there is no expiry, analogous to the convention adopted for <code>nExpiryHeight</code> in ZIP 203 [#zip-0203].</p>
                </section>
                <section id="rationale-for-including-burn-fields-inside-orchardzsa-action-groups"><h4><span class="section-heading">Rationale for including Burn fields inside OrchardZSA Action Groups</span><span class="section-anchor"> <a rel="bookmark" href="#rationale-for-including-burn-fields-inside-orchardzsa-action-groups"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>Note that the v6 transaction format includes the burn fields of the transaction inside the OrchardZSA Action Group rather than at the transaction level. This is a design choice that considers the future scenario where Action Groups may be generated by different parties before being bundled together into a transaction. In such a scenario, the individual parties can burn Assets of their choice in their corresponding Action Groups. Maintaining the burn fields at the transaction level would provide the ability to burn Assets only to the party performing the bundling of the Action Groups.</p>
                </section>
            </section>
            <section id="orchardzsa-action-description-orchardzsaaction"><h3><span class="section-heading">OrchardZSA Action Description (<code>OrchardZSAAction</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#orchardzsa-action-description-orchardzsaaction"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>32</td>
                            <td><code>cv</code></td>
                            <td><code>byte[32]</code></td>
                            <td>A value commitment to the net value of the input note minus the output note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>nullifier</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The nullifier of the input note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>rk</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The randomized validating key for the element of <code>spendAuthSigsOrchard</code> corresponding to this Action.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>cmx</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The
                                <span class="math">\(x\!\)</span>
                            -coordinate of the note commitment for the output note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>ephemeralKey</code></td>
                            <td><code>byte[32]</code></td>
                            <td>An encoding of an ephemeral Pallas public key.</td>
                        </tr>
                        <tr>
                            <td>132</td>
                            <td><code>encCiphertext</code></td>
                            <td><code>byte[132]</code></td>
                            <td>The encrypted contents of the note plaintext.</td>
                        </tr>
                        <tr>
                            <td>80</td>
                            <td><code>outCiphertext</code></td>
                            <td><code>byte[80]</code></td>
                            <td>The encrypted contents of the byte string created by concatenation of the transmission key with the ephemeral secret key.</td>
                        </tr>
                    </tbody>
                </table>
                <p>The encodings of each of these elements are defined in §7.5 ‘Action Description Encoding and Consensus’ <a id="footnote-reference-19" class="footnote_reference" href="#protocol-actiondesc">5</a>.</p>
            </section>
            <section id="orchardzsa-asset-burn-description"><h3><span class="section-heading">OrchardZSA Asset Burn Description</span><span class="section-anchor"> <a rel="bookmark" href="#orchardzsa-asset-burn-description"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>An OrchardZSA Asset Burn description is encoded in a transaction as an instance of an <code>AssetBurn</code> type:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>32</td>
                            <td><code>AssetBase</code></td>
                            <td><code>byte[32]</code></td>
                            <td>For the OrchardZSA protocol, this is the encoding of the Asset Base
                                <span class="math">\(\mathsf{AssetBase^{Orchard}}\!\)</span>
                            .</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>valueBurn</code></td>
                            <td><code>uint64</code></td>
                            <td>The amount being burnt. The value is checked by consensus to be non-zero.</td>
                        </tr>
                    </tbody>
                </table>
                <p>The encodings of each of these elements are defined in ZIP 226 <a id="footnote-reference-20" class="footnote_reference" href="#zip-0226">13</a>.</p>
            </section>
            <section id="transparent-sighash-information-transparentsighashinfo"><h3><span class="section-heading">Transparent Sighash Information (<code>TransparentSighashInfo</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#transparent-sighash-information-transparentsighashinfo"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>compactSize</code></td>
                            <td>The size in bytes of <cite>sighashInfo</cite>.</td>
                        </tr>
                        <tr>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>sighashInfo</code></td>
                            <td><code>byte[sizeSighashInfo]</code></td>
                            <td>The sighash version and associated information <a id="footnote-reference-21" class="footnote_reference" href="#zip-0246-sighash-info">27</a>.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="sapling-signature-saplingsignature"><h3><span class="section-heading">Sapling Signature (<code>SaplingSignature</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#sapling-signature-saplingsignature"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>compactSize</code></td>
                            <td>The size in bytes of <cite>sighashInfo</cite>.</td>
                        </tr>
                        <tr>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>sighashInfo</code></td>
                            <td><code>byte[sizeSighashInfo]</code></td>
                            <td>The sighash version and associated information <a id="footnote-reference-22" class="footnote_reference" href="#zip-0246-sighash-info">27</a>.</td>
                        </tr>
                        <tr>
                            <td>64</td>
                            <td><code>signature</code></td>
                            <td><code>byte[64]</code></td>
                            <td>An encoding of a RedJubjub signature, which may be either a <code>spendAuthSig</code> or <code>bindingSig</code> depending on context.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="orchard-signature-orchardsignature"><h3><span class="section-heading">Orchard Signature (<code>OrchardSignature</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#orchard-signature-orchardsignature"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>compactSize</code></td>
                            <td>The size in bytes of <cite>sighashInfo</cite>.</td>
                        </tr>
                        <tr>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>sighashInfo</code></td>
                            <td><code>byte[sizeSighashInfo]</code></td>
                            <td>The sighash version and associated information <a id="footnote-reference-23" class="footnote_reference" href="#zip-0246-sighash-info">27</a>.</td>
                        </tr>
                        <tr>
                            <td>64</td>
                            <td><code>signature</code></td>
                            <td><code>byte[64]</code></td>
                            <td>An encoding of a RedPallas signature, which may be either a <code>spendAuthSig</code> or <code>bindingSig</code> depending on context.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="issuance-authorization-signature-issueauthsignature"><h3><span class="section-heading">Issuance Authorization Signature (<code>IssueAuthSignature</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#issuance-authorization-signature-issueauthsignature"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>compactSize</code></td>
                            <td>The size in bytes of <cite>sighashInfo</cite>.</td>
                        </tr>
                        <tr>
                            <td><code>sizeSighashInfo</code></td>
                            <td><code>sighashInfo</code></td>
                            <td><code>byte[sizeSighashInfo]</code></td>
                            <td>The sighash version and associated information <a id="footnote-reference-24" class="footnote_reference" href="#zip-0246-sighash-info">27</a>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>sizeSignature</code></td>
                            <td><code>compactSize</code></td>
                            <td>The size in bytes of <cite>signature</cite>.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>signature</code></td>
                            <td><code>byte[sizeSignature]</code></td>
                            <td>The signature of the transaction SIGHASH, signed by the issuer, preceded by a <code>0x00</code> byte indicating a BIP 340 signature. It is validated as specified in <a id="footnote-reference-25" class="footnote_reference" href="#zip-0227-issuance-auth-sig">17</a>.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="issuance-action-description-issueaction"><h3><span class="section-heading">Issuance Action Description (<code>IssueAction</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#issuance-action-description-issueaction"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>An issuance action, <code>IssueAction</code>, is the instance of issuing a specific Custom Asset, and contains the following fields:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>32</td>
                            <td><code>assetDescHash</code></td>
                            <td><code>byte[32]</code></td>
                            <td>A hash of the description of the Custom Asset.</td>
                        </tr>
                        <tr>
                            <td>varies</td>
                            <td><code>nNotes</code></td>
                            <td><code>compactSize</code></td>
                            <td>The number of notes in the Issuance Action.</td>
                        </tr>
                        <tr>
                            <td>115 × <code>nNotes</code></td>
                            <td><code>vNotes</code></td>
                            <td><code>IssueNoteDescription[nNotes]</code></td>
                            <td>A sequence of issue note descriptions within the Issuance Action.</td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td><code>flagsIssuance</code></td>
                            <td><code>byte</code></td>
                            <td>
                                <p>An 8-bit value representing a set of flags. Ordered from LSB to MSB:</p>
                                <ul>
                                    <li>
                                        <span class="math">\(\mathsf{finalize}\)</span>
                                    </li>
                                    <li>The remaining bits are set to
                                        <span class="math">\(0\!\)</span>
                                    .</li>
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p>The encoding of <code>IssueNoteDescription</code> is described below. Note that we allow the number of notes (represented by <code>nNotes</code>) to be zero. This allows for issuers to create Issuance Actions to only finalize an issued Asset, without needing them to simultaneously issue more of that Asset.</p>
            </section>
            <section id="issue-note-description-issuenotedescription"><h3><span class="section-heading">Issue Note Description (<code>IssueNoteDescription</code>)</span><span class="section-anchor"> <a rel="bookmark" href="#issue-note-description-issuenotedescription"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>An issuance note description, <code>IssueNoteDescription</code> contains the following fields:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Bytes</th>
                            <th>Name</th>
                            <th>Data Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>43</td>
                            <td><code>recipient</code></td>
                            <td><code>byte[43]</code></td>
                            <td>The encoding of a recipient's diversified payment address, as
                                <span class="math">\(\mathsf{LEBS2OSP}_{88}(\mathsf{d})\|
\mathsf{LEBS2OSP}_{256}(\mathsf{repr}_{\mathbb{P}}
(\mathsf{pk}_\mathsf{d}))\!\)</span>
                            , where
                                <span class="math">\(\mathsf{d}\)</span>
                             is the diversifier and
                                <span class="math">\(\mathsf{pk_d}\)</span>
                             is the diversified transmission key. <strong>Non Normative Note</strong>: This is the same as the encoding of an Orchard Raw Payment Address, as defined in §5.6.4.2 ‘Orchard Raw Payment Addresses’.</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td><code>value</code></td>
                            <td><code>uint64</code></td>
                            <td>The amount being issued in this note.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>rho</code></td>
                            <td><code>byte[32]</code></td>
                            <td>This is defined and encoded in the same manner as for Orchard notes in §3.2.1 ‘Note Plaintexts and Memo Fields’.</td>
                        </tr>
                        <tr>
                            <td>32</td>
                            <td><code>rseed</code></td>
                            <td><code>byte[32]</code></td>
                            <td>The <code>rseed</code> field of the note, encoded as for Orchard notes in §3.2.1 ‘Note Plaintexts and Memo Fields’.</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section id="note-plaintexts"><h3><span class="section-heading">Note Plaintexts</span><span class="section-anchor"> <a rel="bookmark" href="#note-plaintexts"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>New note plaintext formats using lead byte
                    <span class="math">\(\mathtt{0x03}\)</span>
                 are introduced for Sapling and Orchard, in order to support memo bundles and (for Orchard) ZSAs and quantum recoverability.</p>
                <p>The
                    <span class="math">\(\mathsf{leadByte}\)</span>
                 MUST be
                    <span class="math">\(\mathtt{0x03}\)</span>
                 for all note plaintexts in v6 transactions.</p>
                <section id="sapling-note-plaintext"><h4><span class="section-heading">Sapling Note Plaintext</span><span class="section-anchor"> <a rel="bookmark" href="#sapling-note-plaintext"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>In order to accommodate the change needed for memo bundles <a id="footnote-reference-26" class="footnote_reference" href="#zip-0231-memo-encryption">22</a>, a v6-onward Sapling note plaintext must include a 32-byte memo key
                        <span class="math">\(\mathsf{K^{memo}} : \mathbb{B}^{\mathbb{Y}[32]\!\)</span>
                    , rather than a 512-byte plaintext memo.</p>
                    <p>The corresponding changes to the Zcash Protocol Specification are specified in <a id="footnote-reference-27" class="footnote_reference" href="#zip-0231-sapling-note-plaintext">23</a>.</p>
                    <p>The encoding of a v6-onward Sapling note plaintext in § 5.5 ‘Encodings of Note Plaintexts and Memo Fields’ <a id="footnote-reference-28" class="footnote_reference" href="#protocol-noteptencoding">7</a> is similarly updated and is now defined as:</p>
                    <div class="math">\([\mathsf{leadByte}] \,||\, \mathsf{LEBS2OSP}_{88}(\mathsf{d}) \,||\, \mathsf{I2LEOSP}_{64}(\mathsf{v}) \,||\, \mathsf{rseed} \,||\, \mathsf{K^{memo}}\)</div>
                </section>
                <section id="orchard-note-plaintext"><h4><span class="section-heading">Orchard Note Plaintext</span><span class="section-anchor"> <a rel="bookmark" href="#orchard-note-plaintext"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>As well as the same change to accommodate memo bundles as above, OrchardZSA notes have an additional
                        <span class="math">\(\mathsf{AssetBase}\)</span>
                     field, which needs to be included (as its byte sequence encoding
                        <span class="math">\(\mathsf{asset\_base}\!\)</span>
                    ) in a v6-onward Orchard note plaintext.</p>
                    <p>Let
                        <span class="math">\(\mathcal{V}^{\mathsf{Orchard}}\)</span>
                     be as defined in § 5.4.8.3 ‘Homomorphic Pedersen commitments (Sapling and Orchard)’ <a id="footnote-reference-29" class="footnote_reference" href="#protocol-concretehomomorphiccommit">6</a>.</p>
                    <p>An Orchard note is essentially equivalent to an OrchardZSA note with
                        <span class="math">\(\mathsf{AssetBase} = \mathcal{V}^{\mathsf{Orchard}}\!\)</span>
                    ; in particular, they have the same note commitment (as defined in <a id="footnote-reference-30" class="footnote_reference" href="#zip-0226-note-structure-and-commitment">15</a>), and need not be distinguished in note plaintexts.</p>
                    <p>Each v6-onward Orchard note plaintext consists of</p>
                    <div class="math">\((\mathsf{leadByte} : \mathbb{B}^{\mathbb{Y}}, \mathsf{d} : \mathbb{B}^{[\ell_{\mathsf{d}}]}, \mathsf{v} : \{0 .. 2^{\ell_{\mathsf{value}}} - 1\}, \mathsf{rseed} : \mathbb{B}^{\mathbb{Y}[32]}, \mathsf{asset\_base} : \mathbb{B}^{\mathbb{Y}[\ell_{\mathbb{P}}/8]}, \mathsf{K^{memo}} : \mathbb{B}^{\mathbb{Y}[32]})\)</div>
                    <p>where (consistent with <a id="footnote-reference-31" class="footnote_reference" href="#zip-0226-note-structure-and-commitment">15</a>)
                        <span class="math">\(\mathsf{asset\_base}\)</span>
                     is
                        <span class="math">\(\mathsf{LEBS2OSP}_{\ell_{\mathbb{P}}}(\mathsf{repr}_{\mathbb{P}}(\mathsf{AssetBase}))\!\)</span>
                    .</p>
                    <p>The encoding of a v6-onward Orchard note plaintext in § 5.5 ‘Encodings of Note Plaintexts and Memo Fields’ <a id="footnote-reference-32" class="footnote_reference" href="#protocol-noteptencoding">7</a> is similarly updated and is now defined as:</p>
                    <div class="math">\([\mathsf{leadByte}] \,||\, \mathsf{LEBS2OSP}_{88}(\mathsf{d}) \,||\, \mathsf{I2LEOSP}_{64}(\mathsf{v}) \,||\, \mathsf{rseed} \,||\, \mathsf{asset\_base} \,||\, \mathsf{K^{memo}}\)</div>
                    <p>The encodings of
                        <span class="math">\(\mathsf{d}\!\)</span>
                    ,
                        <span class="math">\(\mathsf{v}\!\)</span>
                    , and
                        <span class="math">\(\mathsf{rseed}\)</span>
                     remain unchanged from the previous specification in §5.5 ‘Encodings of Note Plaintexts and Memo Fields’ of the Zcash Protocol Specification <a id="footnote-reference-33" class="footnote_reference" href="#protocol-noteptencoding">7</a>.</p>
                    <p>Non-normative note: The <em>use</em> of the
                        <span class="math">\(\mathsf{rseed}\)</span>
                     in Orchard note decryption changes, but its type and encoding do not.</p>
                </section>
                <section id="rationale-for-requiring-the-lead-byte-to-be-0x03-in-v6"><h4><span class="section-heading">Rationale for requiring the lead byte to be 0x03 in v6</span><span class="section-anchor"> <a rel="bookmark" href="#rationale-for-requiring-the-lead-byte-to-be-0x03-in-v6"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>It was decided to synchronize the changes to note encryption required for quantum recoverability, ZSA support, and memo bundles with a change to the transaction format, for two reasons:</p>
                    <ul>
                        <li>This was necessary because the note ciphertexts must be a different size to those in v5 transactions — to accommodate the ZSA
                            <span class="math">\(\mathsf{AssetBase}\)</span>
                         field for Orchard, and due to changing the 512-byte
                            <span class="math">\(\mathsf{memo}\)</span>
                         field to a 32-byte
                            <span class="math">\(\mathsf{K^{memo}}\)</span>
                         field for both Sapling and Orchard. In fact the latter change makes it impossible to retain the lead-byte
                            <span class="math">\(\mathtt{0x02}\)</span>
                         format unchanged, because the note ciphertext is not large enough (in either Sapling or Orchard outputs) for a 512-byte memo.</li>
                        <li>The quantum recoverability change did not necessarily have to be done at the same time as the ZSA and memo bundle changes. However, it would have significantly increased overall protocol complexity for there to be a separate note plaintext format for quantum-recoverable notes. Also, doing it at the same time minimizes the risk that non-conformant wallets would create outputs after this change that could not be successfully decrypted by conformant wallets. That could potentially result in inaccessible funds, as was observed with the previous note plaintext change at the Canopy upgrade <a id="footnote-reference-34" class="footnote_reference" href="#zip-0212">10</a>. (As noted above, it is still possible for funds to be temporarily stuck if a <em>receiving</em> wallet does not fully support v6 transactions, but this is less problematic because upgrading the wallet will unstick them.)</li>
                    </ul>
                    <p>Although the ZSA and quantum recoverability-related note plaintext changes do not apply to Sapling, the change from
                        <span class="math">\(\mathsf{memo}\)</span>
                     to
                        <span class="math">\(\mathsf{K^{memo}}\)</span>
                     justifies changing the lead byte for both Sapling and Orchard.</p>
                </section>
            </section>
            <section id="implications-for-mining"><h3><span class="section-heading">Implications for Mining</span><span class="section-anchor"> <a rel="bookmark" href="#implications-for-mining"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>ZIP 235 <a id="footnote-reference-35" class="footnote_reference" href="#zip-0235">25</a> requires that from activation of that ZIP, which is scheduled for NU7, all coinbase transactions created by miners and mining pools are v6 transactions.</p>
                <p>The specification of the Stratum protocol in <a id="footnote-reference-36" class="footnote_reference" href="#zip-0301">28</a> does not need any updates for v6 transactions, but implementations might need to be updated.</p>
            </section>
            <section id="implications-for-wallets"><h3><span class="section-heading">Implications for Wallets</span><span class="section-anchor"> <a rel="bookmark" href="#implications-for-wallets"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <section id="sending-v6-transactions"><h4><span class="section-heading">Sending v6 transactions</span><span class="section-anchor"> <a rel="bookmark" href="#sending-v6-transactions"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p><em>All</em> Zcash wallets SHOULD, without undue delay, switch to sending only v6 transactions once they are allowed on the network. This applies to all transactions regardless of whether they transact in native or non-native assets, or whether they use other v6 features.</p>
                </section>
                <section id="rationale-for-sending-v6-transactions"><h4><span class="section-heading">Rationale for sending v6 transactions</span><span class="section-anchor"> <a rel="bookmark" href="#rationale-for-sending-v6-transactions"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                <details>
<summary>Click to show/hide</summary>
                    <p>This obtains the maximum possible privacy for the wallet's users, maximizes the overall rate of increase of the anonymity set of OrchardZSA commitments, and ensures that users' funds are quantum-recoverable.</p>
                    <p>Because v5 transactions cannot spend or create non-native assets, a wallet using Orchard with v5 transactions is revealing more information than a wallet using it with v6 transactions — i.e. that all of the Orchard notes spent and output by those transactions are ZEC.</p>
                    <p>Only OrchardZSA outputs of v6 transactions are quantum-recoverable, as described and motivated in <a id="footnote-reference-37" class="footnote_reference" href="#draft-ecc-quantum-recoverability">30</a>.</p>
                    <p>Finally, if wallets continue to send v5 transactions then users will not benefit from other v6 transaction features, such as the larger memo sizes enabled by memo bundles <a id="footnote-reference-38" class="footnote_reference" href="#zip-0231-motivation">21</a>, or the benefits of making the fee field explicit <a id="footnote-reference-39" class="footnote_reference" href="#zip-2002-motivation">29</a>.</p>
                </details></section>
                <section id="support-for-receiving-funds-in-v6-transactions"><h4><span class="section-heading">Support for receiving funds in v6 transactions</span><span class="section-anchor"> <a rel="bookmark" href="#support-for-receiving-funds-in-v6-transactions"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>Zcash wallets MUST support parsing and processing v6 transactions by the time they are allowed on the network (scheduled for NU7 activation). This includes detecting and decrypting lead-byte
                        <span class="math">\(\mathtt{0x03}\)</span>
                     note plaintexts and memo bundles.</p>
                    <p>The necessary changes to note decryption are specified in ZIP 231 <a id="footnote-reference-40" class="footnote_reference" href="#zip-0231">20</a>, ZIP 226 <a id="footnote-reference-41" class="footnote_reference" href="#zip-0226-orchardzsa-transaction-structure">14</a>, and draft-ecc-quantum-recoverability <a id="footnote-reference-42" class="footnote_reference" href="#draft-ecc-quantum-recoverability">30</a> (which defines the necessary changes to the Zcash protocol specification). Note that the changes arising from <a id="footnote-reference-43" class="footnote_reference" href="#zip-0231">20</a> apply also to Sapling outputs.</p>
                    <p>In the event that a wallet implementation, contrary to the above requirement, does not support decrypting outputs of v6 transactions (or some subset of them) immediately once they are allowed on the network, it MUST rescan those outputs once that support is added.</p>
                </section>
                <section id="rationale-for-being-ready-to-receive-v6-transactions-at-their-activation"><h4><span class="section-heading">Rationale for being ready to receive v6 transactions at their activation</span><span class="section-anchor"> <a rel="bookmark" href="#rationale-for-being-ready-to-receive-v6-transactions-at-their-activation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h4>
                    <p>Note plaintexts with lead byte
                        <span class="math">\(\mathtt{0x03}\!\)</span>
                    , which are required for Orchard notes in v6 transactions, can be sent to any Orchard address.</p>
                    <p>These notes use a different computation of
                        <span class="math">\(\mathsf{rcm}\)</span>
                     and
                        <span class="math">\(\text{ψ}\)</span>
                     from
                        <span class="math">\(\mathsf{rseed}\!\)</span>
                    , which is necessary in order to achieve quantum recoverability as explained in <a id="footnote-reference-44" class="footnote_reference" href="#draft-ecc-quantum-recoverability-security-analysis">31</a>. They also have a new
                        <span class="math">\(\mathsf{AssetBase}\)</span>
                     field used to support ZSAs. Therefore, they cannot be validated or spent without making <em>all</em> of the specified changes. A wallet attempting to non-conformantly use the note decryption algorithm for lead byte
                        <span class="math">\(\mathtt{0x02}\)</span>
                     would compute a different note commitment
                        <span class="math">\(\mathsf{cm}_x\)</span>
                     and would reject the note.</p>
                    <p>If wallets do not support v6 transactions and lead-byte
                        <span class="math">\(\mathtt{0x03}\)</span>
                     note decryption immediately, then funds may be sent to them that they cannot receive. This affects both the existing Orchard functionality, and receiving non-native ZSA assets.</p>
                    <p>This situation is different from previous upgrades that introduced a new shielded pool, such as the Sapling and NU5 upgrades, because in those cases the new pool used an entirely new address type, and existing wallets would not have given out addresses of those types.</p>
                    <p>Furthermore, as described in [Sending v6 transactions]_, other wallets can be expected to immediately start sending v6 transactions as soon as they are allowed, and so <em>all</em> wallets need to be ready to receive them at that point.</p>
                </section>
            </section>
        </section>
        <section id="deployment"><h2><span class="section-heading">Deployment</span><span class="section-anchor"> <a rel="bookmark" href="#deployment"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>Version 6 transactions are proposed to be allowed on the network starting from Network Upgrade 7. <a id="footnote-reference-45" class="footnote_reference" href="#draft-arya-deploy-nu7">32</a></p>
        </section>
        <section id="reference-implementation"><h2><span class="section-heading">Reference implementation</span><span class="section-anchor"> <a rel="bookmark" href="#reference-implementation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>TODO</p>
        </section>
        <section id="references"><h2><span class="section-heading">References</span><span class="section-anchor"> <a rel="bookmark" href="#references"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <table id="bcp14" class="footnote">
                <tbody>
                    <tr>
                        <th>1</th>
                        <td><a href="https://www.rfc-editor.org/info/bcp14">Information on BCP 14 — "RFC 2119: Key words for use in RFCs to Indicate Requirement Levels" and "RFC 8174: Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol" class="footnote">
                <tbody>
                    <tr>
                        <th>2</th>
                        <td><a href="protocol/protocol.pdf">Zcash Protocol Specification, Version 2025.6.2 or later [NU6.1]</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-spenddesc" class="footnote">
                <tbody>
                    <tr>
                        <th>3</th>
                        <td><a href="protocol/protocol.pdf#spenddesc">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 4.4: Spend Descriptions</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-outputdesc" class="footnote">
                <tbody>
                    <tr>
                        <th>4</th>
                        <td><a href="protocol/protocol.pdf#outputdesc">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 4.5: Output Descriptions</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-actiondesc" class="footnote">
                <tbody>
                    <tr>
                        <th>5</th>
                        <td><a href="protocol/protocol.pdf#actiondesc">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 4.6: Action Descriptions</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-concretehomomorphiccommit" class="footnote">
                <tbody>
                    <tr>
                        <th>6</th>
                        <td><a href="protocol/protocol.pdf#concretehomomorphiccommit">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 5.4.8.3: Homomorphic Pedersen commitments (Sapling and Orchard)</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-noteptencoding" class="footnote">
                <tbody>
                    <tr>
                        <th>7</th>
                        <td><a href="protocol/protocol.pdf#noteptencoding">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 5.5: Encodings of Note Plaintexts and Memo Fields</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="protocol-txnencoding" class="footnote">
                <tbody>
                    <tr>
                        <th>8</th>
                        <td><a href="protocol/protocol.pdf#txnencoding">Zcash Protocol Specification, Version 2025.6.2 [NU6.1]. Section 7.1: Transaction Encoding and Consensus</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0203" class="footnote">
                <tbody>
                    <tr>
                        <th>9</th>
                        <td><a href="zip-0203">ZIP 203: Transaction Expiry</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0212" class="footnote">
                <tbody>
                    <tr>
                        <th>10</th>
                        <td><a href="zip-0212">ZIP 212: Allow Recipient to Derive Ephemeral Secret from Note Plaintext</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0225" class="footnote">
                <tbody>
                    <tr>
                        <th>11</th>
                        <td><a href="zip-0225">ZIP 225: Version 5 Transaction Format</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0225-transaction-format" class="footnote">
                <tbody>
                    <tr>
                        <th>12</th>
                        <td><a href="zip-0225#transaction-format">ZIP 225: Version 5 Transaction Format. Specification: Transaction Format</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0226" class="footnote">
                <tbody>
                    <tr>
                        <th>13</th>
                        <td><a href="zip-0226">ZIP 226: Transfer and Burn of Zcash Shielded Assets</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0226-orchardzsa-transaction-structure" class="footnote">
                <tbody>
                    <tr>
                        <th>14</th>
                        <td><a href="zip-0226#orchardzsa-transaction-structure">ZIP 226: Transfer and Burn of Zcash Shielded Assets — OrchardZSA Transaction Structure</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0226-note-structure-and-commitment" class="footnote">
                <tbody>
                    <tr>
                        <th>15</th>
                        <td><a href="zip-0226#note-structure-and-commitment">ZIP 226: Transfer and Burn of Zcash Shielded Assets — Note Structure and Commitment</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0227" class="footnote">
                <tbody>
                    <tr>
                        <th>16</th>
                        <td><a href="zip-0227">ZIP 227: Issuance of Zcash Shielded Assets</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0227-issuance-auth-sig" class="footnote">
                <tbody>
                    <tr>
                        <th>17</th>
                        <td><a href="zip-0227#issuance-authorization-signature-scheme">ZIP 227: Issuance of Zcash Shielded Assets — Issuance Authorization Signature Scheme</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0227-issuer-identifier" class="footnote">
                <tbody>
                    <tr>
                        <th>18</th>
                        <td><a href="zip-0227#issuer-identifier">ZIP 227: Issuance of Zcash Shielded Assets — Issuer Identifier</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0228" class="footnote">
                <tbody>
                    <tr>
                        <th>19</th>
                        <td><a href="zip-0228">ZIP 228: Asset Swaps for Zcash Shielded Assets</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0231" class="footnote">
                <tbody>
                    <tr>
                        <th>20</th>
                        <td><a href="zip-0231">ZIP 231: Memo Bundles</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0231-motivation" class="footnote">
                <tbody>
                    <tr>
                        <th>21</th>
                        <td><a href="zip-0231#motivation">ZIP 231: Memo Bundles — Motivation</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0231-memo-encryption" class="footnote">
                <tbody>
                    <tr>
                        <th>22</th>
                        <td><a href="zip-0231#memo-encryption">ZIP 231: Memo Bundles — Memo Encryption</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0231-sapling-note-plaintext" class="footnote">
                <tbody>
                    <tr>
                        <th>23</th>
                        <td><a href="zip-0231#changes-to-the-zcash-protocol-specification">ZIP 231: Memo Bundles — Changes to the Zcash Protocol Specification</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0233" class="footnote">
                <tbody>
                    <tr>
                        <th>24</th>
                        <td><a href="zip-0233">ZIP 233: Network Sustainability Mechanism: Removing Funds From Circulation</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0235" class="footnote">
                <tbody>
                    <tr>
                        <th>25</th>
                        <td><a href="zip-0235">ZIP 235: Remove 60% of Transaction Fees From Circulation</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0244" class="footnote">
                <tbody>
                    <tr>
                        <th>26</th>
                        <td><a href="zip-0244">ZIP 244: Transaction Identifier Non-Malleability</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0246-sighash-info" class="footnote">
                <tbody>
                    <tr>
                        <th>27</th>
                        <td><a href="zip-0246#zip-0246-sighash-info">ZIP 246: Digests for the Version 6 Transaction Format</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0301" class="footnote">
                <tbody>
                    <tr>
                        <th>28</th>
                        <td><a href="zip-0301">ZIP 301: Zcash Stratum Protocol</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-2002-motivation" class="footnote">
                <tbody>
                    <tr>
                        <th>29</th>
                        <td><a href="zip-2002#motivation">ZIP 231: Explicit Fees — Motivation</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="draft-ecc-quantum-recoverability" class="footnote">
                <tbody>
                    <tr>
                        <th>30</th>
                        <td><a href="draft-ecc-quantum-recoverability">draft-ecc-quantum-recoverability: Quantum Recoverability</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="draft-ecc-quantum-recoverability-security-analysis" class="footnote">
                <tbody>
                    <tr>
                        <th>31</th>
                        <td><a href="draft-ecc-quantum-recoverability#security-analysis">draft-ecc-quantum-recoverability: Quantum Recoverability — Security Analysis</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="draft-arya-deploy-nu7" class="footnote">
                <tbody>
                    <tr>
                        <th>32</th>
                        <td><a href="draft-arya-deploy-nu7">draft-arya-deploy-nu7: Deployment of the NU7 Network Upgrade</a></td>
                    </tr>
                </tbody>
            </table>
        </section>
    </section>
</body>
</html>