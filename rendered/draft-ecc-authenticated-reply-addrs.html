<!DOCTYPE html>
<html>
<head>
    <title>Draft ecc-authenticated-reply-addrs: Authenticated Reply Addresses</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
<pre><code>ZIP: ???
Title: Authenticated Reply Addresses
Owners: Jack Grigg &lt;jack@electriccoin.co&gt;
        Kris Nuttycombe &lt;kris@electriccoin.co&gt;
        Daira Emma Hopwood &lt;daira@electriccoin.co&gt;
Status: Draft
Category: Standards / Wallet
Created: 2023-11-12
License: MIT
Discussions-To: &lt;<a href="https://github.com/zcash/zips/issues/???">https://github.com/zcash/zips/issues/???</a>&gt;
Pull-Request: &lt;<a href="https://github.com/zcash/zips/pull/???">https://github.com/zcash/zips/pull/???</a>&gt;
</code></pre>

<h1 id="terminology"><span class="section-heading">Terminology</span><span class="section-anchor"> <a rel="bookmark" href="#terminology"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>The key words &#8220;MUST&#8221; and &#8220;SHOULD&#8221; in this document is to be interpreted as described in
BCP 14 <a href="#cn:1" id="cnref:1" title="see citation" class="citation">(1)</a> when, and only when, they appear in all capitals.</p>

<h1 id="abstract"><span class="section-heading">Abstract</span><span class="section-anchor"> <a rel="bookmark" href="#abstract"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>TODO</p>

<h1 id="motivation"><span class="section-heading">Motivation</span><span class="section-anchor"> <a rel="bookmark" href="#motivation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>TODO</p>

<h1 id="specification"><span class="section-heading">Specification</span><span class="section-anchor"> <a rel="bookmark" href="#specification"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<h2 id="authenticatedreplyaddressencoding"><span class="section-heading">Authenticated reply address encoding</span><span class="section-anchor"> <a rel="bookmark" href="#authenticatedreplyaddressencoding"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>

<ul>
<li>Versioning (which could instead be represented by the ZIP 302 TLV type).</li>
<li>The reply address.

<ul>
<li>This uses a binary encoding of a ZIP 316 Unified Address.

<ul>
<li>TODO: decide on specifics - https://github.com/zcash/librustzcash/pull/711#issuecomment-1377783264</li>
</ul></li>
<li>This might be the same address for all inputs, or it might only cover a subset of them
(in a collaborative multi-sender transaction).</li>
</ul></li>
<li>A non-empty list of tuples:

<ul>
<li><span class="math">\(\mathsf{receiver_type}\)</span>: The receiver type for which this proof is made. This receiver
MUST match one of the receiver types in the reply address.</li>
<li><span class="math">\(\mathsf{addr_proof}_\mathsf{pool_type}\)</span>: An address proof for that pool type.</li>
</ul></li>
</ul>

<h2 id="creating"><span class="section-heading">Creating</span><span class="section-anchor"> <a rel="bookmark" href="#creating"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>

<h2 id="verifying"><span class="section-heading">Verifying</span><span class="section-anchor"> <a rel="bookmark" href="#verifying"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>

<ul>
<li>Verify that the transaction is valid (in particular, that all proofs and signatures are valid).</li>
<li>Decrypt the transaction output to obtain the memo field.</li>
<li>Decode the authenticated reply address.

<ul>
<li>This MUST validate the inner encodings of e.g. ZIP 316 for UAs (as applicable).</li>
</ul></li>
<li>Verify each address proof.</li>
</ul>

<h2 id="saplingaddressproof"><span class="section-heading">Sapling address proof</span><span class="section-anchor"> <a rel="bookmark" href="#saplingaddressproof"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>

<h3 id="encoding"><span class="section-heading">Encoding</span><span class="section-anchor"> <a rel="bookmark" href="#encoding"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>

<ul>
<li><span class="math">\(\mathsf{index}\)</span>: An index into <span class="math">\(\mathsf{tx.shieldedSpends}\)</span>.</li>
<li><span class="math">\(\mathsf{nullifier_{addr}}\)</span>: A nullifier for a ZIP 304 fake note. <a href="#cn:2" id="cnref:2" title="see citation" class="citation">(2)</a></li>
<li><span class="math">\(\mathsf{zkproof_{addr}}\)</span>: A Sapling spend proof.</li>
</ul>

<h3 id="creating"><span class="section-heading">Creating</span><span class="section-anchor"> <a rel="bookmark" href="#creating"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>

<p>Taking as input:</p>

<ul>
<li>The Sapling expanded spending key.</li>
<li><span class="math">\(\alpha\)</span>: The randomness used to construct the spend description.</li>
<li><span class="math">\(\mathsf{index}\)</span>: An index into <span class="math">\(\mathsf{tx.shieldedSpends}\)</span>.</li>
</ul>

<p>The Sapling address proof is created as follows:</p>

<ul>
<li>Extract the Sapling receiver from the reply address.</li>
<li>Compute <span class="math">\((\mathsf{nf}, zkproof) = Zip304CreateProof(sapling_receiver, expanded_sk, alpha)\)</span>.</li>
<li>Return <span class="math">\((\mathsf{index}, \mathsf{nf}, zkproof)\)</span></li>
</ul>

<h3 id="verifying"><span class="section-heading">Verifying</span><span class="section-anchor"> <a rel="bookmark" href="#verifying"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>

<ul>
<li>Extract the Sapling receiver from the reply address.</li>
<li>Look up the spend description at <span class="math">\(\mathsf{tx.shieldedSpends}[\mathsf{index}]\)</span>.</li>
<li>Extract <span class="math">\(\mathsf{rk}\)</span> from the spend description.</li>
<li>Call <span class="math">\(Zip304VerifyProof(sapling_receiver, \mathsf{nullifier_{addr}}, \mathsf{rk}, \mathsf{zkproof_{addr}})\)</span>, and return an error if it fails.</li>
</ul>

<h1 id="rationale"><span class="section-heading">Rationale</span><span class="section-anchor"> <a rel="bookmark" href="#rationale"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>We do not generate and include a full ZIP 304 signature in the Sapling address proof; we
only rely on its proof-of-address helper function. This is for two reasons:</p>

<ul>
<li>The ZIP 304 <code>spendAuthSig</code> proves knowledge of the spend authorizing key, but we already
obtain that from the <code>spendAuthSig</code> on the Sapling spend description, so there is no
additional security benefit from including it, and omitting it decreases the encoding
size.</li>
<li>We do not need to encode <code>rk</code> because it is already present in the transaction.</li>
</ul>

<p>The individual address proofs commit to the entire reply address. For example, if the
reply address contains a Sapling and Orchard receiver, but the transaction only spends
Sapling notes, the sender is still confirming that the Orchard receiver is also an allowed
reply address receiver.</p>

<p>However, to have proper cross-linking, we need to ensure that all receivers in the UA have
proofs of spend authority, to prevent a sender from including a receiver that they do not
control (as a form of impersonation attack). There are a few ways this could be resolved:</p>

<ul>
<li>Always require the transaction to spend notes for all receivers.

<ul>
<li>Pro: This could be done with dummy notes for the pools that the sender doesn&#8217;t want to
spend from.</li>
<li>Con: This would prevent the sender from pre-emptively adding receivers for upcoming
shielded pools that are not yet activated.</li>
<li>Con: For UAs with transparent receivers, this would be incompatible with shielded-only
transactions.</li>
</ul></li>
<li>Have an optional proof of spend authority in the address proof.

<ul>
<li>This is omitted when a spent note is present for that receiver type (as the spent note
serves this purpose).</li>
<li>This is pretty much the exact opposite of ZIP 311 (where we require proofs of spend
authority, and have optional proof-of-address).</li>
</ul></li>
</ul>

<p>In any case, doing this for UAs that include Orchard receivers will result in more data
than can be stored in a single memo field, so this is blocked on some kind of multi-part
memo encoding.</p>

<h1 id="securityandprivacyconsiderations"><span class="section-heading">Security and Privacy Considerations</span><span class="section-anchor"> <a rel="bookmark" href="#securityandprivacyconsiderations"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>The verification process for authenticated reply addresses requires that the full
transaction is validated, because it outsources proof-of-spend-authority to the spend
proofs and signatures. As a consequence, wallets that scan transactions via a light client
protocol MUST NOT show the reply address as authenticated until the full transaction has
been downloaded and validated.</p>

<h1 id="referenceimplementation"><span class="section-heading">Reference implementation</span><span class="section-anchor"> <a rel="bookmark" href="#referenceimplementation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<p>TBD</p>

<h1 id="references"><span class="section-heading">References</span><span class="section-anchor"> <a rel="bookmark" href="#references"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h1>

<div class="citations">
<hr />
<ol>

<li id="cn:1">
<p>Information on BCP 14 — &#8220;RFC 2119: Key words for use in RFCs to Indicate Requirement Levels&#8221; and &#8220;RFC 8174: Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words&#8221; <a href="https://www.rfc-editor.org/info/bcp14">https://www.rfc-editor.org/info/bcp14</a> <a href="#cnref:1" title="return to body" class="reversecitation">&#160;&#8617;&#xfe0e;</a></p>
</li>

<li id="cn:2">
<p>zip-0304 <a href="#cnref:2" title="return to body" class="reversecitation">&#160;&#8617;&#xfe0e;</a></p>
</li>

</ol>
</div>
</body>
</html>
